<!Doctype html>
<html lang="zh">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <base href="https://paxinla.github.io">
        <meta property="og:title" content="Blog of Charles" />
        <meta name="author" content="Charles" />
        <meta property="article:author" content="Charles" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://paxinla.github.io" />
        <meta property="og:image" content="https://paxinla.github.io/static/blog_url_qrcode.png" />
        <meta property="og:image:secure_url" content="https://paxinla.github.io/static/blog_url_qrcode.png" />
        <meta property="og:image:type" content="image/png" />
        <meta property="og:image:width" content="120" />
        <meta property="og:image:height" content="120" />
        <meta property="og:image:alt" content="A QR code of the blog's URL." />
        <meta property="og:description" content="This is the blog of Charles." />
        <meta name="copyright" content="Charles" />
        <meta name="description" content="Personal blog of Charles">
        <meta name="generator" content="pelican 3.7.1">
        <link href="https://paxinla.github.io/static/humans.txt" rel="author" type="text/plain" />
        <title>一些 Scala 的 Tips</title>
        <link href="https://paxinla.github.io/posts/2020/04/yi-xie-scala-de-tips.html" rel="canonical" />

        <link href="https://paxinla.github.io/theme/images/favicon.ico" rel="icon" type="image/png" />
        <link href="https://paxinla.github.io/theme/images/safari-pinned-tab.svg" rel="mask-icon" color="#5bbad5" />

        <link href="https://paxinla.github.io/theme/css/blogstyle.css?6748a722" rel="stylesheet" type="text/css" />

        <!-- View Counter -->
        <script defer src="https://events.vercount.one/js"></script>
        <!-- End of View Counter Code -->

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-70MNYH18HG"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-70MNYH18HG');
        </script>
    </head>


    <body data-spy="scroll" data-target="#left-navbar" data-offset="50" itemscope="" itemtype="http://schema.org/WebPage">

        <!-- Cursor animation -->
        <script defer="" src="https://paxinla.github.io/theme/js/animejs.js"></script>
        <script defer="" src="https://paxinla.github.io/theme/js/fireworks.min.js"></script>
        <canvas class="fireworks" style="width:100%; height:100%;"></canvas>

        <div id="whole-page">
        <!-- Left Sidebar -->
        <nav id="left-navbar" class="sidebar">
            <div class="content">
                <div><a href="/"><img src="https://paxinla.github.io/static/icosahedron.jpg" class="img-responsive center-block" style="height:120px;width:120px;border-radius:20px;"/></a></div>
                <br/>
                <div class="center-text narrow-font" style="line-height: 28px;">
                    <span class="nav-item"><i class="fas fa-home"></i><a href="https://paxinla.github.io/"> 首页 </a></span>
                    <span class="center-dot"></span>
                    <span class="nav-item"><i class="fas fa-file-archive"></i><a href="https://paxinla.github.io/archives.html"> 过往文章 </a></span>
                    <br/>
                    <span class="nav-item"><i class="fas fa-tags"></i><a href="https://paxinla.github.io/tags.html"> Tag </a></span>
                    <span class="center-dot"></span>
                    <span class="nav-item"><i class="fa fa-archive"></i><a href="https://paxinla.github.io/categories.html"> Category </a></span>
                    <br/>
                    <span class="nav-item"><i class="fa fa-link"></i><a href="https://paxinla.github.io/links.html"> 友邻 </a></span>
                    <span class="center-dot"></span>
                    <span class="nav-item"><i class="fas fa-user"></i><a href="https://paxinla.github.io/about.html"> 关于我 </a></span>
                </div>
                <hr/> <br/>

<div class="title"><a href="#">一些 Scala 的 Tips</a></div>
<hr/>

                <div id="nav-sidebar">
                </div>

<br/>

                <div id="nav-visited-info" class="center-text floating-description">
                    <div id="copyright-expression" class="copyright"><span style="color:#6fdcdc;">(</span>cons "<a href="https://github.com/paxinla" style="color:#999;">Charles</a> <span style="color:#00ec47;">&copy;</span>" <span style="color:#ff188c;">(</span>iterate inc <span style="color:#db4437;">2014</span><span style="color:#ff188c;">)</span><span style="color:#6fdcdc;">)</span></div><br/>
                    <a id="powered-by" href="https://github.com/getpelican/pelican">Powered by <span id="icon-gear" class="rotating"></span><span style="color:#fbf3f3;"> Pelican</span></a><br/>
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" style="border: none;" ><img src="https://img.shields.io/badge/License-CC__BY--NC--SA-blue.svg" style="height: 17px;" /></a>
                </div>
            </div>
        </nav>

        <!-- Middle and right sections -->
        <div class="page" itemsope="" itemtype="http://schema.org/Blog">
<div class="content-top" style="padding-right: 0">
    <div class="unit-line-height">
        <!-- Post Title -->
        <h1 class="title">
            <div>
                <span itemprop="name">一些 Scala 的 Tips</span>
            </div>
        </h1>

        <!-- Post Meta Info -->
        <div class="marginnote invisible-sm post-detail">
            <div>
                <p><div class="date heading-font"><i class="fa fa-calendar"></i> 2020-04-20 星期一</div>
                    <a href="#" style="margin-left:0.875em;border:none;">
                        <span class="author" itemprop="name">Charles</span>
                    </a>
                </p>

                <p><div class="heading-font"><i class="fas fa-folder"></i> Category</div>
                    <a class="category" href="https://paxinla.github.io/category/scala.html" style="margin-left:0.875em;border:none;">
                         Scala
                    </a>
                </p>

                <p><div class="heading-font"><i class="fas fa-tag"></i> Tags</div>
                    <span style="padding-left:1.4em;"></span>
                        <a class="tag" href="https://paxinla.github.io/tag/scala.html">scala</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Post Image -->
    <br/>
    <img src="" class="cover img-responsive" style="max-height: 400px" itemprop="image">
    <div class="note visible-sm post-detail"></div>

    <hr class="dotty-split-line" />
</div>

            <!-- Content -->
<div class="content"  id="content_of_post" style="padding-right: 0">
    <div class="post" itemprop="blogPost">
        <div id="content_of_article" class="justify word-break" itemprop="articleBody">
            <!-- PELICAN_END_SUMMARY -->
<div id="section1"><h2>一些良好的实践</h2>
<ul>
<li><a href="https://nrinaudo.github.io/scala-best-practices/">Scala Best Practices</a></li>
<li><a href="https://scala.chobit.org">Scala 手账</a></li>
</ul>
</div><div id="section2"><h2>工具相关</h2>
<h3>Ammonite</h3>
<p>自定义 <a href="https://ammonite.io/">Ammonite</a> 国内仓库镜像，修改 <code>$HOME/.ammonite/predef.sc</code> ，添加如下内容：</p>
<pre><code class="lang-scala hljs">
import coursierapi.MavenRepository

interp.repositories() ++= Seq(
  MavenRepository.of("file://" + scala.sys.env("HOME") + "/.m2/repository/"),
  MavenRepository.of("file://" + scala.sys.env("HOME") + "/.ivy2/cache/"),
  MavenRepository.of("https://maven.aliyun.com/repository/public/"),
  MavenRepository.of("https://maven.aliyun.com/repository/central/"),
  MavenRepository.of("https://maven.aliyun.com/repository/google/"),
  MavenRepository.of("https://maven.aliyun.com/repository/apache-snapshots/"),
  MavenRepository.of("https://mirrors.huaweicloud.com/repository/maven/"),
  MavenRepository.of("https://repo1.maven.org/maven2/")
)

</code></pre>
<p>如果是在 Windows 下，环境变量 HOME 改为 HOMEPATH 。</p>
<p>查看编译器对表达式/语法糖的翻译结果，可以用 universe.reify 方法：</p>
<pre><code class="lang-scala hljs">
// reify方法用于对一段表达式参数生成语法树。
import reflect.runtime.universe._

reify( for ( i &lt;- 1 to 10 ) println(i) )

</code></pre>
<h3>Mill</h3>
<p>在使用 <a href="https://github.com/com-lihaoyi/mill">Mill</a> 的 assembly 打包的时候，有个深坑需要注意：mill 默认会在 jar 包里加些脚本内容，以使打包后的 jar 包可以直接执行。但是这种方式处理后的 jar 包格式可能会使某些系统无法识别（用 <code>jar tvf</code> 可能会报错）。解决的办法是在 build.sc 中添加如下内容:</p>
<pre><code class="lang-scala hljs">
override def prependShellScript: T[String] = ""
</code></pre>
<h3>临时的数据库服务器</h3>
<p>有的时候，会需要一个临时的数据库服务器来进行一些测试。此时，不必在本地完整安装全套数据库的服务器组件，可以在内存里模拟一个临时的数据库服务器实例。</p>
<p>以下方案与 <a href="https://www.testcontainers.org">Testcontainers</a> 不同，不需要本地机器上预写安装 Docker 环境。</p>
<p>以在 Ammonite 中执行为例:</p>
<p>运行一个 MySQL 服务器:</p>
<pre><code class="lang-scala hljs">
{
  import $ivy.{
    `com.wix:wix-embedded-mysql:4.6.1`
  }
  import java.util.concurrent.{ TimeoutException, TimeUnit }
  import com.wix.mysql.config.MysqldConfig.aMysqldConfig
  import com.wix.mysql.config.SchemaConfig.aSchemaConfig
  import com.wix.mysql.config.Charset.UTF8
  import com.wix.mysql.EmbeddedMysql.anEmbeddedMysql
  import com.wix.mysql.distribution.Version.v5_7_latest

  val config = aMysqldConfig(v5_7_latest).
               withCharset(UTF8).
               withPort(3306).
               withUser("SomeUserName", "SomePassword").
               withTimeZone("Asia/Shanghai").
               withTimeout(30, TimeUnit.MINUTES).
               withServerVariable("max_connect_errors", 100).build()

  val server = anEmbeddedMysql(config).
               addSchema(aSchemaConfig("test").build()).
               start()
}

// 关闭服务器: server.stop
</code></pre>
<p>运行一个 PostgreSQL 服务器:</p>
<pre><code class="lang-scala hljs">
{
  import $ivy.{
    `com.opentable.components:otj-pg-embedded:0.13.3`
  }
  import com.opentable.db.postgres.embedded.EmbeddedPostgres

  val server = EmbeddedPostgres.builder().setPort(5432).start()
}

// 关闭服务器: server.close
</code></pre>
</div><div id="section3"><h2>代码片段</h2>
<h3>线程池</h3>
<h4>Future</h4>
<pre><code class="lang-scala hljs">
// 使用 Java 的 ExecutorService
import java.util.concurrent.{Executors, ExecutorService}
// 使用 Monix 的 ExecutorService
import $ivy.{`io.monix::monix:3.2.2`}
import monix.execution.Scheduler

import scala.concurrent.{Future, ExecutionContext}


// 使用 Java 的 ExecutorService
// 偷懒 import scala.concurrent.ExecutionContext.Implicits.global

implicit val ec = ExecutionContext.fromExecutor(
  Executors.newFixedThreadPool(6)]
)
// 使用 Monix 的 ExecutorService
// 偷懒 import monix.execution.Scheduler.Implicits.global
implicit val ec = Scheduler.fixedPool(name="testpool", poolSize=6)

val sumFuture: Future[Int] = Future[Int] {
  var sum = 0
  for(i &lt;- Range(1,100000)) sum = sum + i
  sum
}

// 同步阻塞
import scala.concurrent.Await
import scala.concurrent.duration.Duration

val rs: Int = Await.result(sumFuture, Duration.Inf)


// 回调
import scala.util.{Try, Success, Failure}

//// 仅在成功后调用，使用 onSuccess
//// 或 foreach(A =&gt; Unit)、map(A =&gt; A)、flatMap(A =&gt; Future[A])

sumFuture.onSuccess {
  case number =&gt; println(s"Succeed with: ${number}")
}


//// 成功失败都有调用的，使用 onComplete(Try[A] =&gt; Unit)、andThen
//// 或 transform(Try[A] =&gt; Try[B])、transformWith(Try[A] =&gt; Future[B])

def printResult[A](result: Try[A]): Unit = result match {
  case Failure(exception) =&gt; println(s"Failed with: ${exception.getMessage}")
  case Success(number)    =&gt; println(s"Succeed with: ${number}")
}
sumFuture.onComplete(printResult)

sumFuture.andThen {
  case Success(v) =&gt; println(s"The answer is $v")
} andThen {
  case Success(_) =&gt;  sendSuccessSignalHTTPRequest()
  case Failure(_) =&gt;  sendFailureSignalHTTPRequest()
}

val transformed = Future.successful(42).transform {
  case Success(value) =&gt; Success(s"Successfully computed the $value")
  case Failure(cause) =&gt; Failure(new IllegalStateException(cause))
}

val transformed2 = Future.successful(42).transformWith {
  case Success(value) =&gt; Future.success(s"Successfully computed the $value")
  case Failure(cause) =&gt; Future.failure(new IllegalStateException(cause))
}


// 对特定异常进行“掩盖”
val recoveredF: Future[Int] = Future(3 / 0).recover {
  case _: ArithmeticException =&gt; 0
}

val recoveredWithF: Future[Int] = Future(3 / 0).recoverWith {
  case _: ArithmeticException =&gt; sumFuture
}

val failedInt: Future[Int] = Future.failed(
  new IllegalArgumentException("Boom!")
)
failedInt.fallbackTo(Future.successful(42))

</code></pre>
<h4>Task</h4>
<pre><code class="lang-scala hljs">
// 使用 Monix 的 ExecutorService
import $ivy.{`io.monix::monix:3.2.2`}
import monix.execution.Scheduler
import monix.execution.Scheduler.Implicits.global
import monix.eval.Task
import monix.execution.CancelableFuture

// 这里只是定义了运算，并未开始执行。
val sumTask: Task[Int] = Task {
  var sum = 0
  for(i &lt;- Range(1,100000)) sum = sum + i
  sum
}

import scala.util.{Try, Success, Failure}

// 开始执行运算
val cancelable1 = sumTask.runOnComplete {
  case Success(value) =&gt; println(value)
  case Failure(ex) =&gt; println(s"ERR: ${ex.getMessage}")
}

cancelable1.cancel()

val cancelable2 = sumTask.runAsync {
  case Right(value) =&gt; println(value)
  case Left(ex) =&gt; println(s"ERR: ${ex.getMessage}")
}


// Task 转换为 Future
val future1 = sumTask.runToFuture

// Future 转换为 Task
val task1 = Task.deferFuture {
  Future { println("Do something.") }
}


// 立即执行
val sumTask: Task[Int] = Task.now {
  var sum = 0
  for(i &lt;- Range(1,100000)) sum = sum + i
  sum
}

</code></pre>
<h3>日期时间</h3>
<p>Scala 使用的是 Java 的日期时间 API 。自 Java 8 后提供了 java.time、java.time.format、java.time.chrono、java.time.zone 和 java.time.temporal 包。</p>
<pre><code class="lang-scala hljs">
// 时区
import java.time.ZoneId
val tzDefault = ZoneId.systemDefault
val tzHK = ZoneId.of("Asia/Hong_Kong")

import java.time.ZoneOffset
val tzBJ = ZoneOffset.of("+8")


// 时间戳是时间线上的一个点。在纪元 1970-01-01T00:00:00Z 后是正值，之前是负值。
import java.time.Instant

val timeStamp0 = Instant.EPOCH
val timeStampA = Instant.now()
timeStampA.getEpochSecond  // 精确到秒
timeStampA.toEpochMilli    // 精确到毫秒

// 日期时间转时间戳
val timeStampB = LocalDateTime.now().toInstant(ZoneOffset.of("+8"))
// 带时区的日期时间转时间戳不带参数
val timeStampC = ZonedDateTime.now(ZoneId.of("US/Pacific")).toInstant   


// LocalTime 只有时间、LocalDate 只有日期、LocalDateTime 既有日期又有时间
import java.time.LocalDate
import java.time.LocalTime
import java.time.LocalDateTime
import java.time.ZonedDateTime
import java.time.temporal.ChronoUnit

val date1 = LocalDate.now()
val date2 = LocalDate.of(2020, 3, 2)
val tomorrow = date1.plusDays(1)
val yestoday = date1.minus(1, ChronoUnit.DAYS)

val time1 = LocalTime.now()

val dateTime1 = LocalDateTime.now()
val dateTime2 = LocalDateTime.of(2020, 3, 2, 17, 5, 1)
val dateTime3 = LocalDateTime.ofInstant(  // 时间戳转日期
  Instant.now(),
  ZoneId.of("Asia/Shanghai")
)
val dateTime4 = ZonedDateTime.now(ZoneId.of("US/Pacific"))


// 时间间隔 Period 基于日期， Duration 基于时间
import java.time.Period

val period1 = Period.of(3, 2, 1)  // 3年两个月一天的间隔
val period2 = Period.ofWeeks(2)
val period3 = Period.between(LocalDate.now(), LocalDate().minusDays(5))

import java.time.Duration

val duration1 = Duration.of(4, ChronoUnit.HOURS) // 4个小时的间隔
LocalDateTime.now().minus(duration1)
val duration2 = Duration.between(
  LocalDateTime.now(),
  LocalDateTime.now().minusHours(5)
)


// 相较于 java.text.SimpleDateFormat ，
// java.time.format.DateTimeFormatter 是线程安全的。
import java.time.format.DateTimeFormatter
import java.time.format.FormatStyle

val fmt1 = DateTimeFormatter.ofLocalizedDateTime(FormatStyle.MEDIUM)
val fmt2 = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")
datetime1.format(fmt1)

import java.time.format.DateTimeParseException

// 解析日期/时间字符串
val dateTime5 : LocalDateTime = LocalDateTime.parse("2020-01-02 13:01:06", fmt1)

</code></pre>
<h3>集合</h3>
<pre><code class="lang-scala hljs">
// 类似于 Clojure 的 (partition-by identity some-sequence)
@tailrec
def splitOnDifferent[A](s: List[A], acc: Seq[Seq[A]] = Seq()): Seq[Seq[A]] = {
  s match {
    case Nil =&gt; acc
    case fst :: rest =&gt;
      val (part1, part2) = s.span( _ == fst )
      splitOnDifferent(part2, acc :+ part1)
  }
}


// 模式匹配中处理类型擦除
import scala.reflect.runtime.universe.TypeTag

def checkType[T: TypeTag](v: T) = typeOf[T] match {
  case t if t =:= typeOf[List[String]] =&gt; "List of Strings"
  case t if t =:= typeOf[List[Int]] =&gt; "List of Ints"
  case _ =&gt; "Any other type"
}

</code></pre>
<h3>系统环境变量</h3>
<pre><code class="lang-scala hljs">
// 用 Scala 的 sys 对象
sys.env.get("PWD")

// 用 Scala 的 Properties 对象
scala.util.Properties.envOrElse("PWD", "undefined")

scala.util.Properties.envOrNone("PWD")

// 用 Java 的 System 对象
System.getenv("PWD")

</code></pre>
<h3>密码学相关</h3>
<pre><code class="lang-scala hljs">
import $ivy.`org.scorexfoundation::scrypto:2.1.10`

// Base58
import scorex.util.encode.Base58
val decoded = Base58.decode("b2rhe5P4gXftAwvA4eXQ5HJwsER2owDyS9sKaQRRVQPn93bA")
decoded match {
  case Success(v) =&gt; v.map("%02x" format _).mkString
  case Failure(f) =&gt; println(f)
}

</code></pre></div>
        </div>
    </div>
</div>

<a href="https://paxinla.github.io/posts/2020/04/yi-xie-scala-de-tips.html" class="current-page-link">本文链接: https://paxinla.github.io/posts/2020/04/yi-xie-scala-de-tips.html</a>

<!-- Comments -->
<div class="content-split-comment"><hr class="dotty-split-line" /></div>
<div class="content-bottom">
<section class="comments" id="comments">
      <div class="panel panel-primary">
        <div class="panel-heading" role="tab" id="githubissue-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#githubissue-comments" aria-expanded="true" aria-controls="githubissue-comments">
                <i class="fa fa-comments"></i><i id="githubissue-comment_list"> Comments</i>
            </a>
          </h4>
        </div>

        <!-- utterances start -->
        <div id="utter-container"></div>
        <script src="https://utteranc.es/client.js"
          repo="paxinla/paxinla.github.io"
          issue-term="url"
          label="blog_comment"
          theme="boxy-light"
          crossorigin="anonymous"
          async>
        </script>
        <!-- utterances end -->

      </div>
</section>
            <div class="cc-license">
                <p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/"><img alt="知识共享许可协议" style="border-width:0;display:inline-block" src="https://licensebuttons.net/l/by-nc-sa/3.0/cn/88x31.png" /></a>&nbsp;本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh" style="color:#00a67c">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a>进行许可，欢迎转载、演绎，<br/>但是必须保留本文的署名 <a href="https://paxinla.github.io" style="color:rgb(153,51,51);">Charles</a>（包含链接），且不得用于商业目的。</p>
            </div>
            <div class="clearfix"></div>
        </div>

        </div><!-- End Whole Page -->

        <!-- Scripts -->
        <script src="https://paxinla.github.io/theme/js/packed.js?e4252eaf"></script>

        <script src="https://paxinla.github.io/theme/js/article_toc.js" type="text/javascript"></script>

        <!-- Sidebar / Table of Contents -->
        <script type="text/javascript">
         $(function(){$("#toc").tableOfContents(null,{
             startLevel: 2, depth: 1});
             $('body').scrollspy({
                 target: '#nav-sidebar',
                 offset: 20});
         });
        </script>

        <!-- Code Highlighting : highlight.js -->
        <script type="text/javascript">
            hljs.configure({languages:[]});
            hljs.initHighlightingOnLoad();
        </script>

        <!-- Equation Rendering : mathjax -->
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
               jax: ["input/TeX","output/CommonHTML"],
               tex2jax: { inlineMath: [["$","$"], ["\\(", "\\)"]] },
               CommonHTML: {
                   linebreaks: { automatic: true, width: "container" }
               }
            });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML" type="text/javascript"></script>

        <!-- Cat -->
        <script src="https://paxinla.github.io/theme/js/L2Dwidget.min.js"></script>
        <script type="text/javascript">
            var L2DModelArray = ['hijiki', 'tororo'];
            var L2DModelIndex = Math.floor((Math.random()*L2DModelArray.length));
            var L2DModelSelected = L2DModelArray[L2DModelIndex];
            L2Dwidget.init({model: {
                              jsonPath: "https://paxinla.github.io/theme/live2d-widget-model-"+L2DModelSelected+"/assets/"+L2DModelSelected+".model.json",
                            },
                            display: {
                              superSample: 2,
                              width: 100,
                              height: 200,
                              position: 'right',
                              hOffset: 0,
                              vOffset: 0,
                            },
                            mobile: {
                              show: true,
                              scale: 1,
                              motion: true,
                            },
                            react: {
                              opacityDefault: 0.85,
                              opacityOnHover: 0.2,
                            }
                          })
        </script>

        <!-- Funny title -->
        <script type="text/javascript">
            var OriginTitle = document.title;
            document.addEventListener('visibilitychange', function () {
                if (document.hidden) {
                    document.title = '_(:з」∠)_ 呀嚯嘿';
                } else {
                    document.title = OriginTitle;
                }
            });
        </script>
    </body>
</html>