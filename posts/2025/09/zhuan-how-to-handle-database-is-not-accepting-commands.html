<!Doctype html>
<html lang="zh">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <base href="https://paxinla.github.io">
        <meta property="og:title" content="Blog of Charles" />
        <meta name="author" content="Charles" />
        <meta property="article:author" content="Charles" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://paxinla.github.io" />
        <meta property="og:image" content="https://paxinla.github.io/static/blog_url_qrcode.png" />
        <meta property="og:image:secure_url" content="https://paxinla.github.io/static/blog_url_qrcode.png" />
        <meta property="og:image:type" content="image/png" />
        <meta property="og:image:width" content="120" />
        <meta property="og:image:height" content="120" />
        <meta property="og:image:alt" content="A QR code of the blog's URL." />
        <meta property="og:description" content="This is the blog of Charles." />
        <meta name="copyright" content="Charles" />
        <meta name="description" content="Personal blog of Charles">
        <meta name="generator" content="pelican 3.7.1">
        <link href="https://paxinla.github.io/static/humans.txt" rel="author" type="text/plain" />
        <title>[转] How to handle "database is not accepting commands"</title>
        <link href="https://paxinla.github.io/posts/2025/09/zhuan-how-to-handle-database-is-not-accepting-commands.html" rel="canonical" />

        <link href="https://paxinla.github.io/theme/images/favicon.ico" rel="icon" type="image/png" />
        <link href="https://paxinla.github.io/theme/images/safari-pinned-tab.svg" rel="mask-icon" color="#5bbad5" />

        <link href="https://paxinla.github.io/theme/css/blogstyle.css?6748a722" rel="stylesheet" type="text/css" />

        <!-- View Counter -->
        <script defer src="https://events.vercount.one/js"></script>
        <!-- End of View Counter Code -->

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-70MNYH18HG"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-70MNYH18HG');
        </script>
    </head>


    <body data-spy="scroll" data-target="#left-navbar" data-offset="50" itemscope="" itemtype="http://schema.org/WebPage">

        <!-- Cursor animation -->
        <script defer="" src="https://paxinla.github.io/theme/js/animejs.js"></script>
        <script defer="" src="https://paxinla.github.io/theme/js/fireworks.min.js"></script>
        <canvas class="fireworks" style="width:100%; height:100%;"></canvas>

        <div id="whole-page">
        <!-- Left Sidebar -->
        <nav id="left-navbar" class="sidebar">
            <div class="content">
                <div><a href="/"><img src="https://paxinla.github.io/static/icosahedron.jpg" class="img-responsive center-block" style="height:120px;width:120px;border-radius:20px;"/></a></div>
                <br/>
                <div class="center-text narrow-font" style="line-height: 28px;">
                    <span class="nav-item"><i class="fas fa-home"></i><a href="https://paxinla.github.io/"> 首页 </a></span>
                    <span class="center-dot"></span>
                    <span class="nav-item"><i class="fas fa-file-archive"></i><a href="https://paxinla.github.io/archives.html"> 过往文章 </a></span>
                    <br/>
                    <span class="nav-item"><i class="fas fa-tags"></i><a href="https://paxinla.github.io/tags.html"> Tag </a></span>
                    <span class="center-dot"></span>
                    <span class="nav-item"><i class="fa fa-archive"></i><a href="https://paxinla.github.io/categories.html"> Category </a></span>
                    <br/>
                    <span class="nav-item"><i class="fa fa-link"></i><a href="https://paxinla.github.io/links.html"> 友邻 </a></span>
                    <span class="center-dot"></span>
                    <span class="nav-item"><i class="fas fa-user"></i><a href="https://paxinla.github.io/about.html"> 关于我 </a></span>
                </div>
                <hr/> <br/>

<div class="title"><a href="#">[转] How to handle "database is not accepting commands"</a></div>
<hr/>

                <div id="nav-sidebar">
                </div>

<br/>

                <div id="nav-visited-info" class="center-text floating-description">
                    <div id="copyright-expression" class="copyright"><span style="color:#6fdcdc;">(</span>cons "<a href="https://github.com/paxinla" style="color:#999;">Charles</a> <span style="color:#00ec47;">&copy;</span>" <span style="color:#ff188c;">(</span>iterate inc <span style="color:#db4437;">2014</span><span style="color:#ff188c;">)</span><span style="color:#6fdcdc;">)</span></div><br/>
                    <a id="powered-by" href="https://github.com/getpelican/pelican">Powered by <span id="icon-gear" class="rotating"></span><span style="color:#fbf3f3;"> Pelican</span></a><br/>
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" style="border: none;" ><img src="https://img.shields.io/badge/License-CC__BY--NC--SA-blue.svg" style="height: 17px;" /></a>
                </div>
            </div>
        </nav>

        <!-- Middle and right sections -->
        <div class="page" itemsope="" itemtype="http://schema.org/Blog">
<div class="content-top" style="padding-right: 0">
    <div class="unit-line-height">
        <!-- Post Title -->
        <h1 class="title">
            <div>
                <span itemprop="name">[转] How to handle "database is not accepting commands"</span>
            </div>
        </h1>

        <!-- Post Meta Info -->
        <div class="marginnote invisible-sm post-detail">
            <div>
                <p><div class="date heading-font"><i class="fa fa-calendar"></i> 2025-09-19 星期五</div>
                    <a href="#" style="margin-left:0.875em;border:none;">
                        <span class="author" itemprop="name">Charles</span>
                    </a>
                </p>

                <p><div class="heading-font"><i class="fas fa-folder"></i> Category</div>
                    <a class="category" href="https://paxinla.github.io/category/shu-ju-ku.html" style="margin-left:0.875em;border:none;">
                         数据库
                    </a>
                </p>

                <p><div class="heading-font"><i class="fas fa-tag"></i> Tags</div>
                    <span style="padding-left:1.4em;"></span>
                        <a class="tag" href="https://paxinla.github.io/tag/zhuan-zai.html">转载</a>
                        <a class="tag" href="https://paxinla.github.io/tag/postgresql.html">postgresql</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Post Image -->
    <br/>
    <img src="" class="cover img-responsive" style="max-height: 400px" itemprop="image">
    <div class="note visible-sm post-detail"></div>

    <hr class="dotty-split-line" />
</div>

            <!-- Content -->
<div class="content"  id="content_of_post" style="padding-right: 0">
    <div class="post" itemprop="blogPost">
        <div id="content_of_article" class="justify word-break" itemprop="articleBody">
            <p>原文作者: Laurenz Albe</p>
<p>原文链接: <a href="https://www.cybertec-postgresql.com/en/database-is-not-accepting-commands/">https://www.cybertec-postgresql.com/en/database-is-not-accepting-commands/</a></p>
<p>为防遗失，转载一份。</p>

<p>If you ever get the error message "database is not accepting commands", you are dangerously close to <a href="https://www.cybertec-postgresql.com/en/transaction-id-wraparound-a-walk-on-the-wild-side/">transaction ID wraparound</a> . Most PostgreSQL users understand <a href="https://www.cybertec-postgresql.com/en/autovacuum-wraparound-protection-in-postgresql/">the principle behind transaction ID wraparound</a> , but I recently realized that even many PostgreSQL power users have a wrong idea of how to fix the problem. So I decided to write about it in some more detail.</p>
<div id="section1"><h2>How do you end up with "database is not accepting commands"?</h2>
<p>If you end up with this error, your application will have down time while you manually repair the problem. In this state, you can still run queries, but you cannot perform any more data modifications. Few people ever get that far, because PostgreSQL has several lines of defense before it has to take this last, invasive measure:</p>
<ul>
<li>if a table contains live rows older than autovacuum_freeze_max_age transactions (200 million by default), PostgreSQL will launch an anti-wraparound autovacuum worker</li>
<li>if a table contains live rows older than vacuum_failsafe_age transactions (1.6 billion by default), PostgreSQL will launch an emergency anti-wraparound autovacuum worker that skips the index cleanup step and runs as fast as it can</li>
<li>40 million transactions before transaction ID wraparound, you will get warnings in the log</li>
</ul>
<p>Only if none of these safeties can prevent the problem will PostgreSQL stop data modifications.</p>
<p>There are a few ways to prevent PostgreSQL from fixing the problem by itself:</p>
<ul>
<li>keep a database transaction open forever</li>
<li>keep a prepared transaction around without committing it or rolling it back</li>
<li>keep an orphaned replication slot with the standby server having hot_standby_feedback enabled</li>
<li>have data corruption that makes VACUUM fail</li>
</ul>
</div><div id="section2"><h2>What is the proper measure against "database is not accepting commands"?</h2>
<p><a href="https://www.postgresql.org/docs/current/routine-vacuuming.html#VACUUM-FOR-WRAPAROUND">The documentation</a> describes how to fix the problem:</p>
<p>In this condition, any transactions already in progress can continue, but only read-only transactions can be started. Operations that modify database records or truncate relations will fail. The VACUUM command can still be run normally. Note that, contrary to what was sometimes recommended in earlier releases, it is not necessary or desirable to stop the postmaster or enter single-user mode in order to restore normal operation. Instead, follow these steps:</p>
<ol>
<li>Resolve old prepared transactions. You can find these by checking pg_prepared_xacts for rows where age(transactionid) is large. Such transactions should be committed or rolled back.</li>
<li>End long-running open transactions. You can find these by checking <a href="https://www.postgresql.org/docs/current/monitoring-stats.html#MONITORING-PG-STAT-ACTIVITY-VIEW">pg_stat_activity</a> for rows where age(backend_xid) or age(backend_xmin) is large. Such transactions should be committed or rolled back, or the session can be terminated using pg_terminate_backend.</li>
<li>Drop any old replication slots. Use <a href="https://www.postgresql.org/docs/current/monitoring-stats.html#MONITORING-PG-STAT-REPLICATION-VIEW">pg_stat_replication</a> to find slots where age(xmin) or age(catalog_xmin) is large. In many cases, such slots were created for replication to servers that no longer exist, or that have been down for a long time. If you drop a slot for a server that still exists and might still try to connect to that slot, that replica may need to be rebuilt.</li>
<li>Execute VACUUM in the target database. A database-wide VACUUM is simplest; to reduce the time required, it is also possible to issue manual VACUUM commands on the tables where relminxid is oldest. Do not use VACUUM FULL in this scenario, because it requires an XID and will therefore fail, except in super-user mode, where it will instead consume an XID and thus increase the risk of transaction ID wraparound. Do not use VACUUM FREEZE either, because it will do more than the minimum amount of work required to restore normal operation.</li>
<li>Once normal operation is restored, ensure that autovacuum is properly configured in the target database in order to avoid future problems.</li>
</ol>
</div><div id="section3"><h2>Inferior measures that tempt users</h2>
<p>The documentation I quoted above takes care to point out the frequent fallacies:</p>
<ul>
<li>For reasons I will explain later, many people think that you need to shut down PostgreSQL and start it in <a href="https://www.postgresql.org/docs/current/app-postgres.html#APP-POSTGRES-SINGLE-USER">single-user mode</a> to run VACUUM. But that is not necessary. On the contrary: starting the server in single-user mode will complicate recovery and increase the down time. Moreover, single-user mode disarms the safety that prevents you from using any more transaction IDs, and consuming transaction IDs will bring you closer to data corruption by transaction ID wraparound.</li>
<li>Many people think of VACUUM (FULL) as "a better VACUUM", so they are tempted to use it in this dire situation. But VACUUM (FULL) does much more work than a plain VACUUM, and you would end up with a much longer down time. Besides, as the documentation mentions, it will force you to use the single-user mode (see the previous point).</li>
<li>Using VACUUM (FREEZE) would fix the problem, but it freezes all rows of the table. That is more work than necessary and will lead to a longer down time.</li>
</ul>
<p>So, why do people believe that you need single-user mode to recover from "database is not accepting commands"? To answer that, we have to dig into the history of PostgreSQL.</p>
</div><div id="section4"><h2>Source code archaeology, or the history of an error message</h2>
<p>If you don't know how to analyze the history of the PostgreSQL code, I recommend that you read <a href="https://www.cybertec-postgresql.com/en/the-power-of-open-source-in-postgresql/">my article about the true power of open source</a> .</p>
<p><a href="https://postgr.es/c/60b2444cc3ba037630c9b940c3c9ef01b954b87b">Commit 60b2444cc3</a> added the safety margin of three million transaction IDs in 2005 with a message like this:</p>
<blockquote>
<p>ERROR:  database is shut down to avoid wraparound data loss in database "..."</p>
<p>HINT:  Stop the postmaster and use a standalone backend to VACUUM in "...".</p>
</blockquote>
<p>You see the first mention of single-user mode in the form "standalone backend". Since the server didn't actually shut down, <a href="https://postgr.es/c/8ad3965a115bbd5fbd1bb2f3585c2e34d569af7d">commit 8ad3965a11</a>, also in 2005, amended the message to read</p>
<blockquote>
<p>ERROR:  database is not accepting queries to avoid wraparound data loss in database "..."</p>
<p>HINT:  Stop the postmaster and use a standalone backend to VACUUM database "...".</p>
</blockquote>
<p>Note that back then, the advice to use single-user mode was actually correct, since VACUUM used to consume a transaction ID back then. In 2009, <a href="https://postgr.es/c/8d4f2ecd41312e57422901952cbad234d293060b">commit 8d4f2ecd41</a> extended the hint to</p>
<blockquote>
<p>ERROR:  database is not accepting queries to avoid wraparound data loss in database "..."</p>
<p>HINT:  Stop the postmaster and use a standalone backend to VACUUM database "...".</p>
<p>You might also need to commit or roll back old prepared transactions.</p>
</blockquote>
<p>In 2013, <a href="https://postgr.es/c/7dfd5cd21c0091e467b16b31a10e20bbedd0a836">commit 7dfd5cd21c</a> changed the wording to "single-user mode":</p>
<blockquote>
<p>ERROR:  database is not accepting commands to avoid wraparound data loss in database "..."</p>
<p>HINT:  Stop the postmaster and vacuum that database in single-user mode.</p>
<p>You might also need to commit or roll back old prepared transactions.</p>
</blockquote>
<p>And in 2017, <a href="https://postgr.es/c/2958a672b1fed35403b23c2b453aede9f7ef4b39">commit 2958a672b1</a> added stale replication slots as a possible cause:</p>
<blockquote>
<p>ERROR:  database is not accepting commands to avoid wraparound data loss in database "..."</p>
<p>HINT:  Stop the postmaster and vacuum that database in single-user mode.</p>
<p>You might also need to commit or roll back old prepared transactions, or drop stale replication slots.</p>
</blockquote>
<p>This was the state of affairs until PostgreSQL v17. By then, the message had long been inaccurate, ever since <a href="https://postgr.es/c/295e63983d7596ccc5717ff4a0a235ba241a2614">commit 295e63983d</a> introduced "lazy transaction ID allocation" in 2007. In October 2023, <a href="https://postgr.es/c/2406c4e34ccca697bd5a221f8375f335b5841dea">commit 2406c4e34c</a> finally changed the error message to its current form:</p>
<blockquote>
<p>ERROR:  database is not accepting commands that assign new XIDs to avoid wraparound data loss in database "..."</p>
<p>HINT:  Execute a database-wide VACUUM in that database.</p>
<p>You might also need to commit or roll back old prepared transactions, or drop stale replication slots.</p>
</blockquote>
<p>So it is hardly surprising that many PostgreSQL old-timers still believe that you need single-user mode to recover from an impending transaction ID wraparound!</p>
</div><div id="section5"><h2>Conclusion</h2>
<p>We reviewed the correct way to handle "database is not accepting commands" (a plan VACUUM) and explored various inferior responses to the situation. This gave me the opportunity to dig into the history of the PostgreSQL source code again!</p></div>
        </div>
    </div>
</div>

<a href="https://paxinla.github.io/posts/2025/09/zhuan-how-to-handle-database-is-not-accepting-commands.html" class="current-page-link">本文链接: https://paxinla.github.io/posts/2025/09/zhuan-how-to-handle-database-is-not-accepting-commands.html</a>

<!-- Comments -->
<div class="content-split-comment"><hr class="dotty-split-line" /></div>
<div class="content-bottom">
<section class="comments" id="comments">
      <div class="panel panel-primary">
        <div class="panel-heading" role="tab" id="githubissue-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#githubissue-comments" aria-expanded="true" aria-controls="githubissue-comments">
                <i class="fa fa-comments"></i><i id="githubissue-comment_list"> Comments</i>
            </a>
          </h4>
        </div>

        <!-- utterances start -->
        <div id="utter-container"></div>
        <script src="https://utteranc.es/client.js"
          repo="paxinla/paxinla.github.io"
          issue-term="url"
          label="blog_comment"
          theme="boxy-light"
          crossorigin="anonymous"
          async>
        </script>
        <!-- utterances end -->

      </div>
</section>
            <div class="cc-license">
                <p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/"><img alt="知识共享许可协议" style="border-width:0;display:inline-block" src="https://licensebuttons.net/l/by-nc-sa/3.0/cn/88x31.png" /></a>&nbsp;本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh" style="color:#00a67c">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a>进行许可，欢迎转载、演绎，<br/>但是必须保留本文的署名 <a href="https://paxinla.github.io" style="color:rgb(153,51,51);">Charles</a>（包含链接），且不得用于商业目的。</p>
            </div>
            <div class="clearfix"></div>
        </div>

        </div><!-- End Whole Page -->

        <!-- Scripts -->
        <script src="https://paxinla.github.io/theme/js/packed.js?e4252eaf"></script>

        <script src="https://paxinla.github.io/theme/js/article_toc.js" type="text/javascript"></script>

        <!-- Sidebar / Table of Contents -->
        <script type="text/javascript">
         $(function(){$("#toc").tableOfContents(null,{
             startLevel: 2, depth: 1});
             $('body').scrollspy({
                 target: '#nav-sidebar',
                 offset: 20});
         });
        </script>

        <!-- Code Highlighting : highlight.js -->
        <script type="text/javascript">
            hljs.configure({languages:[]});
            hljs.initHighlightingOnLoad();
        </script>

        <!-- Equation Rendering : mathjax -->
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
               jax: ["input/TeX","output/CommonHTML"],
               tex2jax: { inlineMath: [["$","$"], ["\\(", "\\)"]] },
               CommonHTML: {
                   linebreaks: { automatic: true, width: "container" }
               }
            });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML" type="text/javascript"></script>

        <!-- Cat -->
        <script src="https://paxinla.github.io/theme/js/L2Dwidget.min.js"></script>
        <script type="text/javascript">
            var L2DModelArray = ['hijiki', 'tororo'];
            var L2DModelIndex = Math.floor((Math.random()*L2DModelArray.length));
            var L2DModelSelected = L2DModelArray[L2DModelIndex];
            L2Dwidget.init({model: {
                              jsonPath: "https://paxinla.github.io/theme/live2d-widget-model-"+L2DModelSelected+"/assets/"+L2DModelSelected+".model.json",
                            },
                            display: {
                              superSample: 2,
                              width: 100,
                              height: 200,
                              position: 'right',
                              hOffset: 0,
                              vOffset: 0,
                            },
                            mobile: {
                              show: true,
                              scale: 1,
                              motion: true,
                            },
                            react: {
                              opacityDefault: 0.85,
                              opacityOnHover: 0.2,
                            }
                          })
        </script>

        <!-- Funny title -->
        <script type="text/javascript">
            var OriginTitle = document.title;
            document.addEventListener('visibilitychange', function () {
                if (document.hidden) {
                    document.title = '_(:з」∠)_ 呀嚯嘿';
                } else {
                    document.title = OriginTitle;
                }
            });
        </script>
    </body>
</html>