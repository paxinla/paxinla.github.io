<!Doctype html>
<html lang="zh">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <base href="https://paxinla.github.io">
        <meta property="og:title" content="Blog of Charles" />
        <meta name="author" content="Charles" />
        <meta property="article:author" content="Charles" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://paxinla.github.io" />
        <meta property="og:image" content="https://paxinla.github.io/static/blog_url_qrcode.png" />
        <meta property="og:image:secure_url" content="https://paxinla.github.io/static/blog_url_qrcode.png" />
        <meta property="og:image:type" content="image/png" />
        <meta property="og:image:width" content="120" />
        <meta property="og:image:height" content="120" />
        <meta property="og:image:alt" content="A QR code of the blog's URL." />
        <meta property="og:description" content="This is the blog of Charles." />
        <meta name="copyright" content="Charles" />
        <meta name="description" content="Personal blog of Charles">
        <meta name="generator" content="pelican 3.7.1">
        <link href="https://paxinla.github.io/static/humans.txt" rel="author" type="text/plain" />
        <title>Spark join 的时候如何处理数据倾斜</title>
        <link href="https://paxinla.github.io/posts/2021/05/spark-join-de-shi-hou-ru-he-chu-li-shu-ju-qing-xie.html" rel="canonical" />

        <link href="https://paxinla.github.io/theme/images/favicon.ico" rel="icon" type="image/png" />
        <link href="https://paxinla.github.io/theme/images/safari-pinned-tab.svg" rel="mask-icon" color="#5bbad5" />

        <link href="https://paxinla.github.io/theme/css/blogstyle.css?6748a722" rel="stylesheet" type="text/css" />

        <!-- View Counter -->
        <script defer src="https://events.vercount.one/js"></script>
        <!-- End of View Counter Code -->

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-70MNYH18HG"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-70MNYH18HG');
        </script>
    </head>


    <body data-spy="scroll" data-target="#left-navbar" data-offset="50" itemscope="" itemtype="http://schema.org/WebPage">

        <!-- Cursor animation -->
        <script defer="" src="https://paxinla.github.io/theme/js/animejs.js"></script>
        <script defer="" src="https://paxinla.github.io/theme/js/fireworks.min.js"></script>
        <canvas class="fireworks" style="width:100%; height:100%;"></canvas>

        <div id="whole-page">
        <!-- Left Sidebar -->
        <nav id="left-navbar" class="sidebar">
            <div class="content">
                <div><a href="/"><img src="https://paxinla.github.io/static/icosahedron.jpg" class="img-responsive center-block" style="height:120px;width:120px;border-radius:20px;"/></a></div>
                <br/>
                <div class="center-text narrow-font" style="line-height: 28px;">
                    <span class="nav-item"><i class="fas fa-home"></i><a href="https://paxinla.github.io/"> 首页 </a></span>
                    <span class="center-dot"></span>
                    <span class="nav-item"><i class="fas fa-file-archive"></i><a href="https://paxinla.github.io/archives.html"> 过往文章 </a></span>
                    <br/>
                    <span class="nav-item"><i class="fas fa-tags"></i><a href="https://paxinla.github.io/tags.html"> Tag </a></span>
                    <span class="center-dot"></span>
                    <span class="nav-item"><i class="fa fa-archive"></i><a href="https://paxinla.github.io/categories.html"> Category </a></span>
                    <br/>
                    <span class="nav-item"><i class="fa fa-link"></i><a href="https://paxinla.github.io/links.html"> 友邻 </a></span>
                    <span class="center-dot"></span>
                    <span class="nav-item"><i class="fas fa-user"></i><a href="https://paxinla.github.io/about.html"> 关于我 </a></span>
                </div>
                <hr/> <br/>

<div class="title"><a href="#">Spark join 的时候如何处理数据倾斜</a></div>
<hr/>

                <div id="nav-sidebar">
                </div>

<br/>

                <div id="nav-visited-info" class="center-text floating-description">
                    <div id="copyright-expression" class="copyright"><span style="color:#6fdcdc;">(</span>cons "<a href="https://github.com/paxinla" style="color:#999;">Charles</a> <span style="color:#00ec47;">&copy;</span>" <span style="color:#ff188c;">(</span>iterate inc <span style="color:#db4437;">2014</span><span style="color:#ff188c;">)</span><span style="color:#6fdcdc;">)</span></div><br/>
                    <a id="powered-by" href="https://github.com/getpelican/pelican">Powered by <span id="icon-gear" class="rotating"></span><span style="color:#fbf3f3;"> Pelican</span></a><br/>
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" style="border: none;" ><img src="https://img.shields.io/badge/License-CC__BY--NC--SA-blue.svg" style="height: 17px;" /></a>
                </div>
            </div>
        </nav>

        <!-- Middle and right sections -->
        <div class="page" itemsope="" itemtype="http://schema.org/Blog">
<div class="content-top" style="padding-right: 0">
    <div class="unit-line-height">
        <!-- Post Title -->
        <h1 class="title">
            <div>
                <span itemprop="name">Spark join 的时候如何处理数据倾斜</span>
            </div>
        </h1>

        <!-- Post Meta Info -->
        <div class="marginnote invisible-sm post-detail">
            <div>
                <p><div class="date heading-font"><i class="fa fa-calendar"></i> 2021-05-10 星期一</div>
                    <a href="#" style="margin-left:0.875em;border:none;">
                        <span class="author" itemprop="name">Charles</span>
                    </a>
                </p>

                <p><div class="heading-font"><i class="fas fa-folder"></i> Category</div>
                    <a class="category" href="https://paxinla.github.io/category/shu-ju-ping-tai.html" style="margin-left:0.875em;border:none;">
                         数据平台
                    </a>
                </p>

                <p><div class="heading-font"><i class="fas fa-tag"></i> Tags</div>
                    <span style="padding-left:1.4em;"></span>
                        <a class="tag" href="https://paxinla.github.io/tag/spark.html">spark</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Post Image -->
    <br/>
    <img src="" class="cover img-responsive" style="max-height: 400px" itemprop="image">
    <div class="note visible-sm post-detail"></div>

    <hr class="dotty-split-line" />
</div>

            <!-- Content -->
<div class="content"  id="content_of_post" style="padding-right: 0">
    <div class="post" itemprop="blogPost">
        <div id="content_of_article" class="justify word-break" itemprop="articleBody">
            <p>“倾斜”对某些数据来说是自然的特征。</p>

<div id=section1><h2>什么是数据倾斜</h2>
<p>简单地说，数据倾斜就是分区的数据不均衡地分布。很多数据天然就是易“倾斜”的，比如国家的人口、互联网上网站的访问量等等。</p>
</div><div id=section2><h2>Spark 中的 skew join</h2>
<p>在 Spark 中，像 SortMergeJoin/ShuffleHashJoin 这样要求输入数据分区的，容易受数据倾斜的影响；像 BroadcastHashJoin 就比较不容易受数据倾斜的影响，因为它不要求输入数据分区，但它要求 join 的其中一方数据集要足够小。skew join 可以认为是混合使用这两类 join 的的策略。</p>
<p>skew join 是“缓解”了数据倾斜的影响，并不是彻底“解决”了数据倾斜的特征。目前 Spark 实现 skew join 的主要策略有：skew hint, runtime skew mitigation 及 customized AQE skew mitigation <sup id=sf-spark-join-de-shi-hou-ru-he-chu-li-shu-ju-qing-xie-1-back><a href=#sf-spark-join-de-shi-hou-ru-he-chu-li-shu-ju-qing-xie-1 class=simple-footnote title="Suganthi Dewakar &amp; Guanzhou(Tony)Xu. Skew Mitigation For Facebook's Patabyte-Scale Joins. DATA+AI SUMMIT EUROPE,2020.">1</a></sup>。</p>
<h3>Skew hint</h3>
<p>这是一种基于规则的策略。在 Spark SQL 中使用 hint 来描述倾斜的数据的信息:</p>
<pre><code class="lang-sql hljs">
SELECT /*+ SKEWED_ON(a.column=key1,...) */ *
  FROM table_A a
  JOIN table_B b
    ON a.column = b.column
</code></pre>
<p>Spark 根据 hint 的信息，将参与 join 的数据集根据倾斜的 key 分为两部分，对无倾斜的部分使用 SortMergeJoin/ShuffleHashJoin ，对倾斜的部分作 BroadcastHashJoin ，再将两个部分的结果 union 起来。</p>
<p>这种策略减少了运行时的延迟时间，但是要求事先知道具体是哪些 key 有倾斜(这样才能在 hint 中明确列出这些 key)，而且对数据集遍历了两遍。</p>
<h3>Runtime skew mitigation</h3>
<p>这是基于 Spark 2 adaptive 框架的策略。Spark 2 的 adaptive framework 使得执行计划可动态调整，调整的依据是中间结果的统计信息。</p>
<p>过去一个作业执行过程中，所有 reducer 的个数是一样的，都是 <code>spark.sql.shuffle.partitions</code> 。Spark 2 在开启 adaptive execution 后，会通过 ExchangeCoordinator 根据运行时中间阶段的统计信息计算出下一阶段合适的分区数。<span class="sidenote note no-word-break invisible-sm"> 只会合并小的分区，不会拆分大的分区。这样一个 reducer 可能需要读取多个分区，Spark 新增接口，一次 shuffle read 可以读多个分区的数据。</span></p>
<p>通过收集 join input stage 的 MapOutputStatistics 信息，将一个分区的大小与下面的参数相比较:</p>
<ul>
<li><code>min_threshold_config_vale</code> : 如分区大小大于该值。</li>
<li><code>median_ratio * median_size(shuffle)</code> : 如分区大小 N 倍于中位数大小。</li>
<li><code>pct_99_ratio * pct99_size(shuffle)</code> : 如分区大小 N 倍于99百分位数大小。</li>
</ul>
<p>来探测是否发生了数据倾斜。</p>
<p>自动拆分发生了数据倾斜的分区为几个更小的分区，另一方数据集对应的分区复制为相同数量的分区，<span class="sidenote note no-word-break invisible-sm">参考<a href="https://docs.google.com/document/d/1NkXN-ck8jUOS0COz3f8LUW5xzF8j9HFjoZXWGGX2HAg/edit#heading=h.60dh8l6nvck" rel="noopener noreferrer" target=_blank>Skewed Join Optimization Design Doc</a></span>再 join 。</p>
<p>这种策略减少了运行时的延迟时间，不要求事先知道具体是哪些 key 上有数据倾斜，也不需要多次遍历数据集。但是会有额外的 shuffle 在 join 之间或者 join 与聚合操作之间，即使没有数据倾斜现象时也如此。</p>
<p>相关的参数有:</p>
<ul>
<li>spark.sql.adaptive.enabled</li>
<li>spark.sql.adaptive.skewedJoin.enabled  : 自动处理数据倾斜</li>
<li>spark.sql.adaptive.skewedPartitionMaxSplits : 处理一个倾斜分区的 task 个数上限，默认 5 。</li>
<li>spark.sql.adaptive.skewedPartitionRowCountThreshold : 行数低于该值的分区不会当作倾斜，默认值是1千万。</li>
<li>spark.sql.adaptive.skewedPartitionSizeThreshold : 大小小于该值的分区不会当作倾斜，默认值是 64MB 。</li>
<li>spark.sql.adaptive.skewedPartitionFactor : 倾斜因子，用来与各分区大小或行数的中位数相乘，默认是 10 。</li>
</ul>
<h3>Customized AQE skew mitigation</h3>
<p>这是基于 Spark 3 AQE 框架的策略。Spark 3 的 Adaptive Query Execution 能在运行时调整 DAG ，主要是动态合并 shuffle 分区，动态调整 join 策略，动态优化数据倾斜的 join <sup id=sf-spark-join-de-shi-hou-ru-he-chu-li-shu-ju-qing-xie-2-back><a href=#sf-spark-join-de-shi-hou-ru-he-chu-li-shu-ju-qing-xie-2 class=simple-footnote title="Adaptive Query Execution: Speeding Up Spark SQL at Runtime">2</a></sup>。</p>
<p>Spark AQE 动态合并 shuffle 分区:</p>
<p><img alt="Spark AQE 动态合并 shuffle 分区前" src="/images/2021/spark_aqe_partition_coalescing_1.png"></p>
<p><img alt="Spark AQE 动态合并 shuffle 分区后" src="/images/2021/spark_aqe_partition_coalescing_2.png"></p>
<p>Spark AQE 动态调整 join 策略:</p>
<p><img alt="Spark AQE 动态调整 join 策略" src="/images/2021/spark_aqe_switching_join.png"></p>
<p>Spark AQE 动态优化数据倾斜:</p>
<p><img alt="Spark AQE 动态优化数据倾斜前" src="/images/2021/spark_aqe_dynamic_skew_join_1.png"></p>
<p><img alt="Spark AQE 动态优化数据倾斜后" src="/images/2021/spark_aqe_dynamic_skew_join_2.png"></p>
<p>这种策略减少了运行时的延迟时间，不要求事先知道具体是哪些 key 上有数据倾斜，也不需要多次遍历数据集。没有数据倾斜时不会有额外的 shuffle 。</p>
<p>相关的参数有:</p>
<ul>
<li>spark.sql.adaptive.enabled</li>
<li>spark.sql.adaptive.skewedJoin.enabled  : 自动处理数据倾斜</li>
<li>spark.sql.adaptive.skewedPartitionThresholdInBytes : 默认 256MB 。</li>
<li>spark.sql.adaptive.skewedPartitionFactor : 默认为 5 。</li>
</ul>
<p>当一个分区的大小同时满足大于 skewedPartitionThresholdInBytes 及 <code>skewedPartitionFactor * 所有分区大小中位数</code> 时，就被认为是“倾斜”的。</p>
<ul>
<li>spark.sql.adaptive.coalescePartitions.enabled : 默认 true ，动态合并 shuffle 分区。发生在 Shuffle Read 阶段，reduce side task 将数据分片全部拉回，AQE按照分区编号的顺序，依次把小于目标尺寸的分区合并到一起。</li>
<li>spark.sql.adaptive.advisoryPartitionSizeInBytes : 默认 64MB 。</li>
<li>
<p>spark.sql.adaptive.coalescePartitions.minPartitionNum : 最小分区数，默认为集群的默认并行度。最终的targetSize为：首先计算出总的 shuffle 的数据大小 totalPostShuffleInputSize ； maxTargetSize 为 max(totalPostShuffleInputSize / minPartitionNum, 16)； targetSize = min(maxTargetSize, advisoryPartitionSizeInBytes)。</p>
</li>
<li>
<p>spark.sql.adaptive.localShuffleReader.enabled : 默认 true ，动态调整 join 策略。</p>
</li>
<li>spark.sql.autoBroadcastJoinThreshold : 广播阈值，默认 10MB 。</li>
<li>spark.sql.adaptive.nonEmptyPartitionRatioForBroadcastJoin : 默认 0.2 。</li>
</ul>
<p>当两张表完成 Shuffle Write 阶段后，AQE 会继续判断某一张表是否满足一下两个条件: 中间文件尺寸总和小于广播阈值
；空文件占比小于配置项 nonEmptyPartitionRatioForBroadcastJoin 。只要有一个表满足就会把 Shuffle Joins 降级为 Broadcast Join（仅适用于 Shuffle Sort Merge Join）。两张大表 join，超过了广播阈值的话 Spark SQL 最初会选择 SortMerge Join ，AQE 只有结合两个表 join 中的 Exchange 才能进行降级判断，所以两张表必须都完成 map side task 且中间文件落盘。AQE 才会决定是否降级以及用哪张表做广播变量。</p></div><br><h6 id=ref-docs-title>参考</h6><ol class=simple-footnotes><li id=sf-spark-join-de-shi-hou-ru-he-chu-li-shu-ju-qing-xie-1>Suganthi Dewakar &amp; Guanzhou(Tony)Xu. Skew Mitigation For Facebook's Patabyte-Scale Joins. DATA+AI SUMMIT EUROPE,2020. <a href=#sf-spark-join-de-shi-hou-ru-he-chu-li-shu-ju-qing-xie-1-back class=simple-footnote-back>↩</a></li><li id=sf-spark-join-de-shi-hou-ru-he-chu-li-shu-ju-qing-xie-2><a href="https://databricks.com/blog/2020/05/29/adaptive-query-execution-speeding-up-spark-sql-at-runtime.html">Adaptive Query Execution: Speeding Up Spark SQL at Runtime</a> <a href=#sf-spark-join-de-shi-hou-ru-he-chu-li-shu-ju-qing-xie-2-back class=simple-footnote-back>↩</a></li></ol>
        </div>
    </div>
</div>

<a href="https://paxinla.github.io/posts/2021/05/spark-join-de-shi-hou-ru-he-chu-li-shu-ju-qing-xie.html" class="current-page-link">本文链接: https://paxinla.github.io/posts/2021/05/spark-join-de-shi-hou-ru-he-chu-li-shu-ju-qing-xie.html</a>

<!-- Comments -->
<div class="content-split-comment"><hr class="dotty-split-line" /></div>
<div class="content-bottom">
<section class="comments" id="comments">
      <div class="panel panel-primary">
        <div class="panel-heading" role="tab" id="githubissue-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#githubissue-comments" aria-expanded="true" aria-controls="githubissue-comments">
                <i class="fa fa-comments"></i><i id="githubissue-comment_list"> Comments</i>
            </a>
          </h4>
        </div>

        <!-- utterances start -->
        <div id="utter-container"></div>
        <script src="https://utteranc.es/client.js"
          repo="paxinla/paxinla.github.io"
          issue-term="url"
          label="blog_comment"
          theme="boxy-light"
          crossorigin="anonymous"
          async>
        </script>
        <!-- utterances end -->

      </div>
</section>
            <div class="cc-license">
                <p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/"><img alt="知识共享许可协议" style="border-width:0;display:inline-block" src="https://licensebuttons.net/l/by-nc-sa/3.0/cn/88x31.png" /></a>&nbsp;本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh" style="color:#00a67c">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a>进行许可，欢迎转载、演绎，<br/>但是必须保留本文的署名 <a href="https://paxinla.github.io" style="color:rgb(153,51,51);">Charles</a>（包含链接），且不得用于商业目的。</p>
            </div>
            <div class="clearfix"></div>
        </div>

        </div><!-- End Whole Page -->

        <!-- Scripts -->
        <script src="https://paxinla.github.io/theme/js/packed.js?e4252eaf"></script>

        <script src="https://paxinla.github.io/theme/js/article_toc.js" type="text/javascript"></script>

        <!-- Sidebar / Table of Contents -->
        <script type="text/javascript">
         $(function(){$("#toc").tableOfContents(null,{
             startLevel: 2, depth: 1});
             $('body').scrollspy({
                 target: '#nav-sidebar',
                 offset: 20});
         });
        </script>

        <!-- Code Highlighting : highlight.js -->
        <script type="text/javascript">
            hljs.configure({languages:[]});
            hljs.initHighlightingOnLoad();
        </script>

        <!-- Equation Rendering : mathjax -->
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
               jax: ["input/TeX","output/CommonHTML"],
               tex2jax: { inlineMath: [["$","$"], ["\\(", "\\)"]] },
               CommonHTML: {
                   linebreaks: { automatic: true, width: "container" }
               }
            });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML" type="text/javascript"></script>

        <!-- Cat -->
        <script src="https://paxinla.github.io/theme/js/L2Dwidget.min.js"></script>
        <script type="text/javascript">
            var L2DModelArray = ['hijiki', 'tororo'];
            var L2DModelIndex = Math.floor((Math.random()*L2DModelArray.length));
            var L2DModelSelected = L2DModelArray[L2DModelIndex];
            L2Dwidget.init({model: {
                              jsonPath: "https://paxinla.github.io/theme/live2d-widget-model-"+L2DModelSelected+"/assets/"+L2DModelSelected+".model.json",
                            },
                            display: {
                              superSample: 2,
                              width: 100,
                              height: 200,
                              position: 'right',
                              hOffset: 0,
                              vOffset: 0,
                            },
                            mobile: {
                              show: true,
                              scale: 1,
                              motion: true,
                            },
                            react: {
                              opacityDefault: 0.85,
                              opacityOnHover: 0.2,
                            }
                          })
        </script>

        <!-- Funny title -->
        <script type="text/javascript">
            var OriginTitle = document.title;
            document.addEventListener('visibilitychange', function () {
                if (document.hidden) {
                    document.title = '_(:з」∠)_ 呀嚯嘿';
                } else {
                    document.title = OriginTitle;
                }
            });
        </script>
    </body>
</html>