<!Doctype html>
<html lang="zh">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <base href="https://paxinla.github.io">
        <meta property="og:title" content="Blog of Charles" />
        <meta name="author" content="Charles" />
        <meta property="article:author" content="Charles" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://paxinla.github.io" />
        <meta property="og:image" content="https://paxinla.github.io/static/blog_url_qrcode.png" />
        <meta property="og:image:secure_url" content="https://paxinla.github.io/static/blog_url_qrcode.png" />
        <meta property="og:image:type" content="image/png" />
        <meta property="og:image:width" content="120" />
        <meta property="og:image:height" content="120" />
        <meta property="og:image:alt" content="A QR code of the blog's URL." />
        <meta property="og:description" content="This is the blog of Charles." />
        <meta name="copyright" content="Charles" />
        <meta name="description" content="Personal blog of Charles">
        <meta name="generator" content="pelican 3.7.1">
        <link href="https://paxinla.github.io/static/humans.txt" rel="author" type="text/plain" />
        <title>Avro - 在 Scala 中使用 Avro RPC</title>
        <link href="https://paxinla.github.io/posts/2021/05/avro-zai-scala-zhong-shi-yong-avro-rpc.html" rel="canonical" />

        <link href="https://paxinla.github.io/theme/images/favicon.ico" rel="icon" type="image/png" />
        <link href="https://paxinla.github.io/theme/images/safari-pinned-tab.svg" rel="mask-icon" color="#5bbad5" />

        <link href="https://paxinla.github.io/theme/css/blogstyle.css?6748a722" rel="stylesheet" type="text/css" />

        <!-- View Counter -->
        <script defer src="https://events.vercount.one/js"></script>
        <!-- End of View Counter Code -->

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-70MNYH18HG"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-70MNYH18HG');
        </script>
    </head>


    <body data-spy="scroll" data-target="#left-navbar" data-offset="50" itemscope="" itemtype="http://schema.org/WebPage">

        <!-- Cursor animation -->
        <script defer="" src="https://paxinla.github.io/theme/js/animejs.js"></script>
        <script defer="" src="https://paxinla.github.io/theme/js/fireworks.min.js"></script>
        <canvas class="fireworks" style="width:100%; height:100%;"></canvas>

        <div id="whole-page">
        <!-- Left Sidebar -->
        <nav id="left-navbar" class="sidebar">
            <div class="content">
                <div><a href="/"><img src="https://paxinla.github.io/static/icosahedron.jpg" class="img-responsive center-block" style="height:120px;width:120px;border-radius:20px;"/></a></div>
                <br/>
                <div class="center-text narrow-font" style="line-height: 28px;">
                    <span class="nav-item"><i class="fas fa-home"></i><a href="https://paxinla.github.io/"> 首页 </a></span>
                    <span class="center-dot"></span>
                    <span class="nav-item"><i class="fas fa-file-archive"></i><a href="https://paxinla.github.io/archives.html"> 过往文章 </a></span>
                    <br/>
                    <span class="nav-item"><i class="fas fa-tags"></i><a href="https://paxinla.github.io/tags.html"> Tag </a></span>
                    <span class="center-dot"></span>
                    <span class="nav-item"><i class="fa fa-archive"></i><a href="https://paxinla.github.io/categories.html"> Category </a></span>
                    <br/>
                    <span class="nav-item"><i class="fa fa-link"></i><a href="https://paxinla.github.io/links.html"> 友邻 </a></span>
                    <span class="center-dot"></span>
                    <span class="nav-item"><i class="fas fa-user"></i><a href="https://paxinla.github.io/about.html"> 关于我 </a></span>
                </div>
                <hr/> <br/>

<div class="title"><a href="#">Avro - 在 Scala 中使用 Avro RPC</a></div>
<hr/>

                <div id="nav-sidebar">
                </div>

<br/>

                <div id="nav-visited-info" class="center-text floating-description">
                    <div id="copyright-expression" class="copyright"><span style="color:#6fdcdc;">(</span>cons "<a href="https://github.com/paxinla" style="color:#999;">Charles</a> <span style="color:#00ec47;">&copy;</span>" <span style="color:#ff188c;">(</span>iterate inc <span style="color:#db4437;">2014</span><span style="color:#ff188c;">)</span><span style="color:#6fdcdc;">)</span></div><br/>
                    <a id="powered-by" href="https://github.com/getpelican/pelican">Powered by <span id="icon-gear" class="rotating"></span><span style="color:#fbf3f3;"> Pelican</span></a><br/>
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" style="border: none;" ><img src="https://img.shields.io/badge/License-CC__BY--NC--SA-blue.svg" style="height: 17px;" /></a>
                </div>
            </div>
        </nav>

        <!-- Middle and right sections -->
        <div class="page" itemsope="" itemtype="http://schema.org/Blog">
<div class="content-top" style="padding-right: 0">
    <div class="unit-line-height">
        <!-- Post Title -->
        <h1 class="title">
            <div>
                <span itemprop="name">Avro - 在 Scala 中使用 Avro RPC</span>
            </div>
        </h1>

        <!-- Post Meta Info -->
        <div class="marginnote invisible-sm post-detail">
            <div>
                <p><div class="date heading-font"><i class="fa fa-calendar"></i> 2021-05-02 星期日</div>
                    <a href="#" style="margin-left:0.875em;border:none;">
                        <span class="author" itemprop="name">Charles</span>
                    </a>
                </p>

                <p><div class="heading-font"><i class="fas fa-folder"></i> Category</div>
                    <a class="category" href="https://paxinla.github.io/category/scala.html" style="margin-left:0.875em;border:none;">
                         Scala
                    </a>
                </p>

                <p><div class="heading-font"><i class="fas fa-tag"></i> Tags</div>
                    <span style="padding-left:1.4em;"></span>
                        <a class="tag" href="https://paxinla.github.io/tag/scala.html">scala</a>
                        <a class="tag" href="https://paxinla.github.io/tag/avro.html">avro</a>
                        <a class="tag" href="https://paxinla.github.io/tag/mill.html">mill</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Post Image -->
    <br/>
    <img src="" class="cover img-responsive" style="max-height: 400px" itemprop="image">
    <div class="note visible-sm post-detail"></div>

    <hr class="dotty-split-line" />
</div>

            <!-- Content -->
<div class="content"  id="content_of_post" style="padding-right: 0">
    <div class="post" itemprop="blogPost">
        <div id="content_of_article" class="justify word-break" itemprop="articleBody">
            <p>在 Scala 中使用 Avro RPC 的示例。</p>

<div id="section1"><h2>什么是 Avro</h2>
<p><a href="http://avro.apache.org/">Apache Avro</a> 是一个数据序列化的系统。 Avro 可以将数据结构或对象转化成便于存储或传输的格式。 Avro 设计之初就用来支持数据密集型应用，适合于远程或本地大规模数据的存储和交换。</p>
<p>Avro 提供了:</p>
<ul>
<li>丰富的数据结构类型。</li>
<li>快速可压缩的二进制数据形式，对数据二进制序列化后可以节约数据存储空间和网络传输带宽。</li>
<li>存储持久数据的文件容器。</li>
<li>可以实现远程过程调用RPC。</li>
<li>简单的动态语言结合功能。</li>
</ul>
</div><div id="section2"><h2>使用 Avro</h2>
<p>Apache Avro 通常作为序列化/反序列化的工具来使用，它也提供 RPC 的功能。</p>
<p>Apache Avro 虽然支持多种语言，但是并不原生支持 Scala 。我在本文中将使用 <a href="https://com-lihaoyi.github.io/mill/">mill</a> 作为构建工具来展示一个简单的使用 Avro 作为 RPC 的示例。本文的例子使用与<a href="https://paxinla.github.io/posts/2021/04/scalapb-zai-scala-zhong-shi-yong-grpc.html">gRPC例子</a>相似的结构。</p>
<p class="list-title">项目结构:</p>
<article><header><pre>
AvroExample
  |
  +-- ServerExample
  |     |-- resources
  |     |     +-- hello.avpr
  |     +-- src
  |           |-- RPCServer.scala
  |           +-- HelloServer.scala
  |     
  +-- ClientExample
  |     |-- resources
  |     |     +-- hello.avpr
  |     +-- src
  |           +-- HelloClient.scala
  |
  +-- build.sc
  |
  +-- lib
       +-- avro-tools-1.10.2.jar
</pre></header></article>
<h3>定义服务</h3>
<p>Avro 定义数据结构有几种方式，通常 <code>.avdl</code> 用一种紧凑的方式定义数据结构，<code>.avpr</code> 用类似 JSON 的形式定义一个 Protocol ，<code>.avsc</code> 用类似 JSON 的形式定义一个 Schema 。这里我用 Protocol 的方式。</p>
<p>hello.avpr 内容:</p>
<pre><code class="lang-avro hljs">
{ "protocol": "HelloWorld",
  "namespace": "learn.avro.services",

  "types": [
    { "name": "Person",
      "type": "record",
      "fields": [
        { "name": "name",
          "type": "string"
        }
      ]
    },
    { "name": "ToBeGreeted",
      "type": "record",
      "fields": [
        { "name": "person",
          "type": "Person"
        },
        { "name": "msg",
          "type": "string"
        }
      ]
    },
    { "name": "Greeting",
      "type": "record",
      "fields": [
        { "name": "message",
          "type": "string"
        }
      ]
    }
  ],

  "messages": {
    "sayHello": {
      "request": [
         { "name": "request",
           "type": "ToBeGreeted"
         }
       ],
      "response": "Greeting"
    }
  }
}
</code></pre>
<h3>服务端</h3>
<p>RPCServer.scala 内容:</p>
<pre><code class="lang-scala hljs">
package learn.avro.server

import java.net.InetSocketAddress

import org.apache.avro.ipc.Server
import org.apache.avro.ipc.netty.NettyServer
import org.apache.avro.ipc.specific.SpecificResponder


trait RPCServer {
  def runServer(
    responder: SpecificResponder,
    address: InetSocketAddress
  ): Unit = {
    val server = new NettyServer(
      responder,
      address
    )

    println("Start Server.")

    Runtime.getRuntime.addShutdownHook(new Thread() {
      override def run(): Unit = {
        println("Shutdown server.")
        server.close()
        server.join()
      }
    })

  }
}
</code></pre>
<p>HelloServer.scala 内容:</p>
<pre><code class="lang-scala hljs">
package learn.avro.hello.server

import java.net.InetSocketAddress

import learn.avro.server.RPCServer
import learn.avro.services._

import org.apache.avro.ipc.specific.SpecificResponder


object HelloServer extends RPCServer {

  class HelloService extends HelloWorld {
    override def sayHello(request: ToBeGreeted): Greeting = {
      val greeter = request.getPerson() match {
        case aperson: Person =&gt; aperson.getName()
        case _ =&gt; "friend"
      }

      val messageText = request.getMsg().toString match {
        case msg if msg.length &gt; 0 =&gt; msg
        case _ =&gt; "~No message~"
      }

      val greeting = new Greeting(s"Hello ${greeter}, ${messageText}")
      greeting
    }
  }

  def main(args: Array[String]): Unit = {
    val serviceHandler = new HelloService()
    val responder = new SpecificResponder(classOf[HelloWorld], serviceHandler)

    runServer(responder, new InetSocketAddress("127.0.0.1", 40032))
  }
}
</code></pre>
<h3>客户端</h3>
<p>HelloClient.scala 内容:</p>
<pre><code class="lang-scala hljs">
package learn.avro.hello.client

import java.net.InetSocketAddress

import org.apache.avro.ipc.netty.NettyTransceiver
import org.apache.avro.ipc.specific.SpecificRequestor

import learn.avro.services._


object HelloClient {
  def main(args: Array[String]): Unit = {
    val timeoutMs = 3000

    val client = new NettyTransceiver(
      new InetSocketAddress("127.0.0.1", 40032),
      timeoutMs
    )

    val syncStub = SpecificRequestor.getClient(classOf[HelloWorld], client)

    val greeter = new ToBeGreeted()
    greeter.setPerson(new Person("Doris"))
    greeter.setMsg("remote greetings!")

    val response: Greeting = syncStub.sayHello(greeter)

    println(s"${response.getMessage()}")
    client.close(true)
  }
}
</code></pre>
<h3>构建工具</h3>
<p>因为没有插件支持 mill 来根据 Avro 服务定义生成相应代码，所以在 mill 里自定义了 Command 类型的 Task ，命令行调用 avro tools 的 jar 包来生成 Java 代码。</p>
<p>build.sc 内容:</p>
<pre><code class="lang-scala hljs">
import mill._
import mill.scalalib._

trait ScalaAvroExample extends ScalaModule {
  def scalaVersion = "2.13.3"
  def avroVersion = "1.10.2"

  override def ivyDeps = T {
    super.ivyDeps() ++ Agg(
      ivy"org.apache.avro:avro:$avroVersion",
      ivy"org.apache.avro:avro-ipc-netty:$avroVersion"
    )
  }

  def avroToolsJar = os.pwd / 'lib / s"avro-tools-${avroVersion}.jar"
  def sharedAvroProtocol = "hello.avpr"
  def projectRoot = os.pwd
  def avprPath = projectRoot / 'resources / sharedAvroProtocol
  def genAvroPath = projectRoot / 'src


  def genAvro() = T.command {
    os.proc('java, "-jar", avroToolsJar,
            "compile", "protocol",
            avprPath, genAvroPath
           ).call()
  }
}

// java -jar lib\avro-tools-1.10.2.jar compile protocol \
//    ServerExample\resources\hello.avpr ServerExample\src
object ServerExample extends ScalaAvroExample {
  override def projectRoot = os.pwd / 'ServerExample
}

// java -jar lib\avro-tools-1.10.2.jar compile protocol \
//    ServerExample\resources\hello.avpr ClientExample\src
object ClientExample extends ScalaAvroExample {
  override def projectRoot = os.pwd / 'ClientExample
}
</code></pre>
<h3>测试</h3>
<p>首先，在 AvroExample 下执行 <code>mill -i ServerExample.genAvro</code>，在 <code>ServerExample/src</code> 下就会生成对应 avro 定义的 Java 代码。<span class="sidenote note no-word-break invisible-sm"> 在 Windows 上这个 <code>-i</code> 是不可缺少的。</span>再执行 <code>mill -i ServerExample.run</code> 就会编译并执行服务端代码。</p>
<p>在 AvroExample 下执行 <code>mill -i ClientExample.genAvro</code>，在 <code>ClientExample/src</code> 下就会生成对应 avro 定义的 Java 代码。再执行 <code>mill -i ClientExample.run</code> 就会编译并执行客户端代码。可以客户端调用 sayHello 的结果：</p>
</div><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>Hello Doris, remote greetings!
</code></pre></div></td></tr></table></div>
        </div>
    </div>
</div>

<a href="https://paxinla.github.io/posts/2021/05/avro-zai-scala-zhong-shi-yong-avro-rpc.html" class="current-page-link">本文链接: https://paxinla.github.io/posts/2021/05/avro-zai-scala-zhong-shi-yong-avro-rpc.html</a>

<!-- Comments -->
<div class="content-split-comment"><hr class="dotty-split-line" /></div>
<div class="content-bottom">
<section class="comments" id="comments">
      <div class="panel panel-primary">
        <div class="panel-heading" role="tab" id="githubissue-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#githubissue-comments" aria-expanded="true" aria-controls="githubissue-comments">
                <i class="fa fa-comments"></i><i id="githubissue-comment_list"> Comments</i>
            </a>
          </h4>
        </div>

        <!-- utterances start -->
        <div id="utter-container"></div>
        <script src="https://utteranc.es/client.js"
          repo="paxinla/paxinla.github.io"
          issue-term="url"
          label="blog_comment"
          theme="boxy-light"
          crossorigin="anonymous"
          async>
        </script>
        <!-- utterances end -->

      </div>
</section>
            <div class="cc-license">
                <p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/"><img alt="知识共享许可协议" style="border-width:0;display:inline-block" src="https://licensebuttons.net/l/by-nc-sa/3.0/cn/88x31.png" /></a>&nbsp;本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh" style="color:#00a67c">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a>进行许可，欢迎转载、演绎，<br/>但是必须保留本文的署名 <a href="https://paxinla.github.io" style="color:rgb(153,51,51);">Charles</a>（包含链接），且不得用于商业目的。</p>
            </div>
            <div class="clearfix"></div>
        </div>

        </div><!-- End Whole Page -->

        <!-- Scripts -->
        <script src="https://paxinla.github.io/theme/js/packed.js?e4252eaf"></script>

        <script src="https://paxinla.github.io/theme/js/article_toc.js" type="text/javascript"></script>

        <!-- Sidebar / Table of Contents -->
        <script type="text/javascript">
         $(function(){$("#toc").tableOfContents(null,{
             startLevel: 2, depth: 1});
             $('body').scrollspy({
                 target: '#nav-sidebar',
                 offset: 20});
         });
        </script>

        <!-- Code Highlighting : highlight.js -->
        <script type="text/javascript">
            hljs.configure({languages:[]});
            hljs.initHighlightingOnLoad();
        </script>

        <!-- Equation Rendering : mathjax -->
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
               jax: ["input/TeX","output/CommonHTML"],
               tex2jax: { inlineMath: [["$","$"], ["\\(", "\\)"]] },
               CommonHTML: {
                   linebreaks: { automatic: true, width: "container" }
               }
            });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML" type="text/javascript"></script>

        <!-- Cat -->
        <script src="https://paxinla.github.io/theme/js/L2Dwidget.min.js"></script>
        <script type="text/javascript">
            var L2DModelArray = ['hijiki', 'tororo'];
            var L2DModelIndex = Math.floor((Math.random()*L2DModelArray.length));
            var L2DModelSelected = L2DModelArray[L2DModelIndex];
            L2Dwidget.init({model: {
                              jsonPath: "https://paxinla.github.io/theme/live2d-widget-model-"+L2DModelSelected+"/assets/"+L2DModelSelected+".model.json",
                            },
                            display: {
                              superSample: 2,
                              width: 100,
                              height: 200,
                              position: 'right',
                              hOffset: 0,
                              vOffset: 0,
                            },
                            mobile: {
                              show: true,
                              scale: 1,
                              motion: true,
                            },
                            react: {
                              opacityDefault: 0.85,
                              opacityOnHover: 0.2,
                            }
                          })
        </script>

        <!-- Funny title -->
        <script type="text/javascript">
            var OriginTitle = document.title;
            document.addEventListener('visibilitychange', function () {
                if (document.hidden) {
                    document.title = '_(:з」∠)_ 呀嚯嘿';
                } else {
                    document.title = OriginTitle;
                }
            });
        </script>
    </body>
</html>