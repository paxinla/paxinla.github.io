<!Doctype html>
<html lang="zh">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <base href="https://paxinla.github.io">
        <meta property="og:title" content="Blog of Charles" />
        <meta name="author" content="Charles" />
        <meta property="article:author" content="Charles" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://paxinla.github.io" />
        <meta property="og:image" content="https://paxinla.github.io/static/blog_url_qrcode.png" />
        <meta property="og:image:secure_url" content="https://paxinla.github.io/static/blog_url_qrcode.png" />
        <meta property="og:image:type" content="image/png" />
        <meta property="og:image:width" content="120" />
        <meta property="og:image:height" content="120" />
        <meta property="og:image:alt" content="A QR code of the blog's URL." />
        <meta property="og:description" content="This is the blog of Charles." />
        <meta name="copyright" content="Charles" />
        <meta name="description" content="Personal blog of Charles">
        <meta name="generator" content="pelican 3.7.1">
        <link href="https://paxinla.github.io/static/humans.txt" rel="author" type="text/plain" />
        <title>SQL技巧：连续时间区间类问题</title>
        <link href="https://paxinla.github.io/posts/2021/04/sqlji-qiao-lian-xu-shi-jian-qu-jian-lei-wen-ti.html" rel="canonical" />

        <link href="https://paxinla.github.io/theme/images/favicon.ico" rel="icon" type="image/png" />
        <link href="https://paxinla.github.io/theme/images/safari-pinned-tab.svg" rel="mask-icon" color="#5bbad5" />

        <link href="https://paxinla.github.io/theme/css/blogstyle.css?6748a722" rel="stylesheet" type="text/css" />

        <!-- View Counter -->
        <script defer src="https://events.vercount.one/js"></script>
        <!-- End of View Counter Code -->

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-70MNYH18HG"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-70MNYH18HG');
        </script>
    </head>


    <body data-spy="scroll" data-target="#left-navbar" data-offset="50" itemscope="" itemtype="http://schema.org/WebPage">

        <!-- Cursor animation -->
        <script defer="" src="https://paxinla.github.io/theme/js/animejs.js"></script>
        <script defer="" src="https://paxinla.github.io/theme/js/fireworks.min.js"></script>
        <canvas class="fireworks" style="width:100%; height:100%;"></canvas>

        <div id="whole-page">
        <!-- Left Sidebar -->
        <nav id="left-navbar" class="sidebar">
            <div class="content">
                <div><a href="/"><img src="https://paxinla.github.io/static/icosahedron.jpg" class="img-responsive center-block" style="height:120px;width:120px;border-radius:20px;"/></a></div>
                <br/>
                <div class="center-text narrow-font" style="line-height: 28px;">
                    <span class="nav-item"><i class="fas fa-home"></i><a href="https://paxinla.github.io/"> 首页 </a></span>
                    <span class="center-dot"></span>
                    <span class="nav-item"><i class="fas fa-file-archive"></i><a href="https://paxinla.github.io/archives.html"> 过往文章 </a></span>
                    <br/>
                    <span class="nav-item"><i class="fas fa-tags"></i><a href="https://paxinla.github.io/tags.html"> Tag </a></span>
                    <span class="center-dot"></span>
                    <span class="nav-item"><i class="fa fa-archive"></i><a href="https://paxinla.github.io/categories.html"> Category </a></span>
                    <br/>
                    <span class="nav-item"><i class="fa fa-link"></i><a href="https://paxinla.github.io/links.html"> 友邻 </a></span>
                    <span class="center-dot"></span>
                    <span class="nav-item"><i class="fas fa-user"></i><a href="https://paxinla.github.io/about.html"> 关于我 </a></span>
                </div>
                <hr/> <br/>

<div class="title"><a href="#">SQL技巧：连续时间区间类问题</a></div>
<hr/>

                <div id="nav-sidebar">
                </div>

<br/>

                <div id="nav-visited-info" class="center-text floating-description">
                    <div id="copyright-expression" class="copyright"><span style="color:#6fdcdc;">(</span>cons "<a href="https://github.com/paxinla" style="color:#999;">Charles</a> <span style="color:#00ec47;">&copy;</span>" <span style="color:#ff188c;">(</span>iterate inc <span style="color:#db4437;">2014</span><span style="color:#ff188c;">)</span><span style="color:#6fdcdc;">)</span></div><br/>
                    <a id="powered-by" href="https://github.com/getpelican/pelican">Powered by <span id="icon-gear" class="rotating"></span><span style="color:#fbf3f3;"> Pelican</span></a><br/>
                    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" style="border: none;" ><img src="https://img.shields.io/badge/License-CC__BY--NC--SA-blue.svg" style="height: 17px;" /></a>
                </div>
            </div>
        </nav>

        <!-- Middle and right sections -->
        <div class="page" itemsope="" itemtype="http://schema.org/Blog">
<div class="content-top" style="padding-right: 0">
    <div class="unit-line-height">
        <!-- Post Title -->
        <h1 class="title">
            <div>
                <span itemprop="name">SQL技巧：连续时间区间类问题</span>
            </div>
        </h1>

        <!-- Post Meta Info -->
        <div class="marginnote invisible-sm post-detail">
            <div>
                <p><div class="date heading-font"><i class="fa fa-calendar"></i> 2021-04-15 星期四</div>
                    <a href="#" style="margin-left:0.875em;border:none;">
                        <span class="author" itemprop="name">Charles</span>
                    </a>
                </p>

                <p><div class="heading-font"><i class="fas fa-folder"></i> Category</div>
                    <a class="category" href="https://paxinla.github.io/category/sqlji-qiao.html" style="margin-left:0.875em;border:none;">
                         SQL技巧
                    </a>
                </p>

                <p><div class="heading-font"><i class="fas fa-tag"></i> Tags</div>
                    <span style="padding-left:1.4em;"></span>
                        <a class="tag" href="https://paxinla.github.io/tag/sql.html">sql</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Post Image -->
    <br/>
    <img src="" class="cover img-responsive" style="max-height: 400px" itemprop="image">
    <div class="note visible-sm post-detail"></div>

    <hr class="dotty-split-line" />
</div>

            <!-- Content -->
<div class="content"  id="content_of_post" style="padding-right: 0">
    <div class="post" itemprop="blogPost">
        <div id="content_of_article" class="justify word-break" itemprop="articleBody">
            <p>有一类 SQL 题目，统计范围要求限定日期/时间要连续，以连续的部分为单位。</p>

<p>如果有诸如“最近...”这样的条件，体现到 WHERE 子句中。如果一行记录中有多个时间粒度，只保留相关的时间粒度，用相关的维度去重，每个时间单位对每个分组维度只保留一条数据。这些都是常规操作了。</p>
<p>要点还是在于如何判断并分组符合题目“连续”定义的行。这时可以开窗口，PARTITION BY 主维度，ORDER BY 时间维度，用分析函数 <code>ROW_NUMBER</code> 给时间维度加序号。然后再用日期减去<span class="emp-text">序号个</span>时间单位。那么连续的时间值得到的<span class="emp-text">时间差值</span>结果将会是一样的，这就完成了对“连续”的时间区间的判断及分组。后面再做统计计算时，只需将这个时间差值加入到分组条件中即可。</p>
<p>上面这种方法，是因为 <code>ROW_NUMBER</code> 产生的序号，间隔是1；通常情况下，题目中“连续”的定义也是指时间单位间隔为1，所谓的 consecutive series of events 。因此“连续”时间区间的各个时间值减去自己对应的“序号个时间单位”，得到的值都是该时间区间中第一个时间减去它的“序号个时间单位”的值。</p>
<p>即:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="err">隐含条件</span><span class="o">:</span><span class="w"> </span><span class="n">gap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">才为“连续”</span>

<span class="w">  </span><span class="n">date1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no1</span>
<span class="o">=</span><span class="w"> </span><span class="n">some_date1</span>


<span class="w">  </span><span class="n">date2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no2</span>
<span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">(</span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span>
<span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no1</span>
<span class="o">=</span><span class="w"> </span><span class="n">some_date1</span>


<span class="w">  </span><span class="n">date3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no3</span>
<span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">(</span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span>
<span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span>
<span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no1</span>
<span class="o">=</span><span class="w"> </span><span class="n">some_date1</span>


<span class="err">#这里</span><span class="w"> </span><span class="n">date4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span>
<span class="w">  </span><span class="n">date4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no4</span>
<span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="o">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">(</span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="o">)</span>
<span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span>
<span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="o">=</span><span class="w"> </span><span class="n">some_date2</span>

<span class="o">...</span><span class="w"> </span><span class="o">...</span>
</code></pre></div></td></tr></table></div>
<p>数据样例:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code>| data column | row number | date diff  |
|-------------+------------+------------|
| 2021-04-03  | 1          | 2021-04-02 |
| 2021-04-04  | 2          | 2021-04-02 |
| 2021-04-05  | 3          | 2021-04-02 |
| 2021-04-07  | 4          | 2021-04-03 | &lt;-- gap before this row
| 2021-04-08  | 5          | 2021-04-03 |
| 2021-04-09  | 6          | 2021-04-03 |
| 2021-04-10  | 7          | 2021-04-03 |
| 2021-04-15  | 8          | 2021-04-07 | &lt;-- gap before this row
| 2021-04-16  | 9          | 2021-04-07 |
| 2021-04-17  | 10         | 2021-04-07 |

... ...
</code></pre></div></td></tr></table></div>
<p>如果时间“连续”的定义变化为只要不超过n个时间单位的时间都算是“连续”呢？比如，本来隔一天就不算是“连续每日”，现在要求将“间隔2天内”都当作是“连续”的日期。</p>
<p>这时就需要两个辅助数据，这里用 df 与 accdf 来标识。</p>
<p>在 PARTITION BY 的小分组中，对每一个日期与它 LAG 取的前一个日期相减得出的时间间隔 readTimeUnitDiff，与题目时间间隔条件相比较，如果符合“连续”的定义，则计该行的 df 值为 (readTimeUnitDiff - 1) ，否则为 0 。</p>
<p>在 PARTITION BY 的小分组中，开窗从整个小分组第一行到当前行的 df 累加值就是这一行的 accdf 值。</p>
<p>有了这两个辅助数据，在上面提到的方法中，对“时间差值”再减去一个 accdf 来“修正”，就可使得最后的差值与时间间隔为1个时间单位时一致。</p>
<p>即:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="err">条件</span><span class="o">:</span><span class="w"> </span><span class="n">gap</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">均视为“连续”</span>

<span class="n">date1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">some_date1</span>


<span class="err">#这里</span><span class="w"> </span><span class="n">date2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="n">accdf</span><span class="o">=</span><span class="mi">1</span>
<span class="w">  </span><span class="n">date2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">accdf</span>
<span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">(</span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">(</span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no1</span>
<span class="o">=</span><span class="w"> </span><span class="n">some_date1</span>


<span class="err">#这里</span><span class="w"> </span><span class="n">date3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="o">,</span><span class="w"> </span><span class="n">df</span><span class="o">=</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="n">accdf</span><span class="o">=</span><span class="mi">1</span>
<span class="w">  </span><span class="n">date3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">accdf</span>
<span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="o">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">(</span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no1</span>
<span class="o">=</span><span class="w"> </span><span class="n">some_date1</span>


<span class="err">#这里</span><span class="w"> </span><span class="n">date4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">6</span><span class="o">,</span><span class="w"> </span><span class="n">df</span><span class="o">=</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="n">accdf</span><span class="o">=</span><span class="mi">1</span>
<span class="w">  </span><span class="n">date4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">accdf</span>
<span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">6</span><span class="o">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">(</span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="o">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span>
<span class="o">=</span><span class="w"> </span><span class="n">some_date2</span>

<span class="err">#这里</span><span class="w"> </span><span class="n">date5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">7</span><span class="o">,</span><span class="w"> </span><span class="n">df</span><span class="o">=</span><span class="mi">0</span><span class="o">,</span><span class="w"> </span><span class="n">accdf</span><span class="o">=</span><span class="mi">1</span>
<span class="w">  </span><span class="n">date5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">accdf</span>
<span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">7</span><span class="o">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">(</span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="o">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="o">=</span><span class="w"> </span><span class="n">date1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sequence_no1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span>
<span class="o">=</span><span class="w"> </span><span class="n">some_date2</span>

<span class="o">...</span><span class="w"> </span><span class="o">...</span>
</code></pre></div></td></tr></table></div>
<p>数据样例:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code>| data column | row number | df | accdf | date diff  |
|-------------+------------+----+-------+------------|
| 2021-04-03  | 1          | 0  | 0     | 2021-04-02 |
| 2021-04-04  | 2          | 0  | 0     | 2021-04-02 |
| 2021-04-06  | 3          | 1  | 1     | 2021-04-02 |
| 2021-04-07  | 4          | 0  | 1     | 2021-04-02 |
| 2021-04-10  | 5          | 0  | 1     | 2021-04-04 | &lt;-- gap before this row
| 2021-04-12  | 6          | 1  | 2     | 2021-04-04 |
| 2021-04-13  | 7          | 0  | 2     | 2021-04-04 |
| 2021-04-14  | 8          | 0  | 2     | 2021-04-04 |
| 2021-04-20  | 9          | 0  | 2     | 2021-04-09 | &lt;-- gap before this row
| 2021-04-21  | 10         | 0  | 2     | 2021-04-09 |

... ...
</code></pre></div></td></tr></table></div>
<p>再做一次判断+分组，把符合条件的“时间差值”归到一组中去，后续的统计要把这个新的“组”加到分组条件中。</p>
<p>例题: 有表 tableAAA 结构如下:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">|</span><span class="w"> </span><span class="n">column_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data_type</span><span class="w">   </span><span class="o">|</span>
<span class="o">|-------------+-------------|</span>
<span class="o">|</span><span class="w"> </span><span class="n">user_id</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">varchar</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">company_id</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">varchar</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">rec_date</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">date</span><span class="w">        </span><span class="o">|</span><span class="w"> </span>
<span class="o">|</span><span class="w"> </span><span class="n">start_time</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">timestamp</span><span class="w">   </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">end_time</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">timestamp</span><span class="w">   </span><span class="o">|</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>求最近两周每个用户最大连续使用服务天数。</li>
<li>设间隔2天使用服务依然算是“连续使用服务”，求最近两周每个用户最大连续使用服务天数。</li>
</ol>
<p>以 PostgreSQL 写法作答:</p>
<pre><code class="lang-pgsql hljs">
-- 1.
WITH step1 AS (
SELECT t.user_id
     , t.rec_date
     , ROW_NUMBER()
       OVER(PARTITION BY t.user_id
                ORDER BY t.rec_date)  AS rn
  FROM tableAAA t
 WHERE t.rec_date &lt;= CURRENT_DATE - INTERVAL '2 WEEKS'
), step2 AS (
 SELECT a.user_id
      , a.rec_date
      , a.rec_date
      - (a.rn * '1 day'::interval)  AS diff_date 
   FROM step1 a
), step3 AS (
  SELECT b.user_id
       , b.diff_date
       , COUNT(1)    AS cnt
    FROM step2 b 
GROUP BY b.user_id, b.diff_date
) SELECT c.user_id
       , MAX(c.cnt)   AS max_consecutive_cnt
    FROM step3 c
GROUP BY c.user_id
;



-- 2.
WITH step1 AS (
SELECT t.user_id
     , t.rec_date
     , ROW_NUMBER()
       OVER(PARTITION BY t.user_id
                ORDER BY t.rec_date)  AS rn
     , CASE WHEN (t.rec_date
                  - LAG(t.rec_date, 1,
                        (t.rec_date - '1 day'::interval)::date)
                    OVER(PARTITION BY t.user_id
                             ORDER BY t.rec_date)
                 ) &lt;= 2
            THEN (t.rec_date
                  - LAG(t.rec_date, 1,
                        (t.rec_date - '1 day'::interval)::date)
                    OVER(PARTITION BY t.user_id
                             ORDER BY t.rec_date)
                 ) - 1
            ELSE 0
       END             AS df
  FROM tableAAA t
 WHERE t.rec_date &lt;= CURRENT_DATE - INTERVAL '2 WEEKS'
), step2 AS ( 
 SELECT a.user_id
      , a.rec_date
      , a.rec_date
      - (a.rn * '1 day'::interval)  AS origin_diff_date 
      , a.df
      , SUM(a.df)
        OVER(PARTITION BY a.user_id
                 ORDER BY a.rec_date 
                  ROWS BETWEEN UNBOUNDED PRECEDING
                           AND CURRENT ROW
            )      AS accdf
   FROM step1 a
), step3 AS (
  SELECT b.user_id
       , b.origin_diff_date
       - (b.accdf * '1 day'::interval)  AS diff_date
       , COUNT(1)    AS cnt
    FROM step2 b
GROUP BY b.user_id, diff_date
) SELECT c.user_id
       , MAX(c.cnt)   AS max_consecutive_cnt
    FROM step3 c
GROUP BY c.user_id
;

</code></pre>
        </div>
    </div>
</div>

<a href="https://paxinla.github.io/posts/2021/04/sqlji-qiao-lian-xu-shi-jian-qu-jian-lei-wen-ti.html" class="current-page-link">本文链接: https://paxinla.github.io/posts/2021/04/sqlji-qiao-lian-xu-shi-jian-qu-jian-lei-wen-ti.html</a>

<!-- Comments -->
<div class="content-split-comment"><hr class="dotty-split-line" /></div>
<div class="content-bottom">
<section class="comments" id="comments">
      <div class="panel panel-primary">
        <div class="panel-heading" role="tab" id="githubissue-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#githubissue-comments" aria-expanded="true" aria-controls="githubissue-comments">
                <i class="fa fa-comments"></i><i id="githubissue-comment_list"> Comments</i>
            </a>
          </h4>
        </div>

        <!-- utterances start -->
        <div id="utter-container"></div>
        <script src="https://utteranc.es/client.js"
          repo="paxinla/paxinla.github.io"
          issue-term="url"
          label="blog_comment"
          theme="boxy-light"
          crossorigin="anonymous"
          async>
        </script>
        <!-- utterances end -->

      </div>
</section>
            <div class="cc-license">
                <p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/"><img alt="知识共享许可协议" style="border-width:0;display:inline-block" src="https://licensebuttons.net/l/by-nc-sa/3.0/cn/88x31.png" /></a>&nbsp;本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh" style="color:#00a67c">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a>进行许可，欢迎转载、演绎，<br/>但是必须保留本文的署名 <a href="https://paxinla.github.io" style="color:rgb(153,51,51);">Charles</a>（包含链接），且不得用于商业目的。</p>
            </div>
            <div class="clearfix"></div>
        </div>

        </div><!-- End Whole Page -->

        <!-- Scripts -->
        <script src="https://paxinla.github.io/theme/js/packed.js?e4252eaf"></script>

        <script src="https://paxinla.github.io/theme/js/article_toc.js" type="text/javascript"></script>

        <!-- Sidebar / Table of Contents -->
        <script type="text/javascript">
         $(function(){$("#toc").tableOfContents(null,{
             startLevel: 2, depth: 1});
             $('body').scrollspy({
                 target: '#nav-sidebar',
                 offset: 20});
         });
        </script>

        <!-- Code Highlighting : highlight.js -->
        <script type="text/javascript">
            hljs.configure({languages:[]});
            hljs.initHighlightingOnLoad();
        </script>

        <!-- Equation Rendering : mathjax -->
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
               jax: ["input/TeX","output/CommonHTML"],
               tex2jax: { inlineMath: [["$","$"], ["\\(", "\\)"]] },
               CommonHTML: {
                   linebreaks: { automatic: true, width: "container" }
               }
            });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML" type="text/javascript"></script>

        <!-- Cat -->
        <script src="https://paxinla.github.io/theme/js/L2Dwidget.min.js"></script>
        <script type="text/javascript">
            var L2DModelArray = ['hijiki', 'tororo'];
            var L2DModelIndex = Math.floor((Math.random()*L2DModelArray.length));
            var L2DModelSelected = L2DModelArray[L2DModelIndex];
            L2Dwidget.init({model: {
                              jsonPath: "https://paxinla.github.io/theme/live2d-widget-model-"+L2DModelSelected+"/assets/"+L2DModelSelected+".model.json",
                            },
                            display: {
                              superSample: 2,
                              width: 100,
                              height: 200,
                              position: 'right',
                              hOffset: 0,
                              vOffset: 0,
                            },
                            mobile: {
                              show: true,
                              scale: 1,
                              motion: true,
                            },
                            react: {
                              opacityDefault: 0.85,
                              opacityOnHover: 0.2,
                            }
                          })
        </script>

        <!-- Funny title -->
        <script type="text/javascript">
            var OriginTitle = document.title;
            document.addEventListener('visibilitychange', function () {
                if (document.hidden) {
                    document.title = '_(:з」∠)_ 呀嚯嘿';
                } else {
                    document.title = OriginTitle;
                }
            });
        </script>
    </body>
</html>